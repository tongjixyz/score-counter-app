<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>äº’åŠ¨è®¡åˆ†å™¨</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Chosen Palette: Warm Neutrals & Primary Accents (Blue, Red, Green, Yellow) */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        
        /* --- æ ¸å¿ƒç§»åŠ¨ç«¯ä¼˜åŒ–ï¼šç¦ç”¨åŒå‡»ç¼©æ”¾å’Œæ–‡æœ¬é€‰æ‹© --- */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f7f9fb; /* æµ…ç°è‰²èƒŒæ™¯ */
            /* é˜²æ­¢å¿«é€Ÿç‚¹å‡»å¯¼è‡´å±å¹•æ”¾å¤§ */
            touch-action: manipulation; 
            /* é˜²æ­¢å¿«é€Ÿç‚¹å‡»é€‰ä¸­æ–‡å­— */
            -webkit-user-select: none; /* iOS/Safari */
            user-select: none;
            /* ç§»é™¤ç‚¹å‡»æ—¶çš„åŠé€æ˜ç°è‰²é«˜äº® */
            -webkit-tap-highlight-color: transparent; 
        }
        
        /* ç¡®ä¿è®¡åˆ†æŒ‰é’®ä¹Ÿç»§æ‰¿è¿™ä¸ªé‡è¦çš„è§¦æ§å±æ€§ */
        .score-control-btn {
            touch-action: manipulation;
        }
        /* ------------------------------------------- */

        /* è·èƒœåŠ¨ç”»ï¼šèƒœåˆ©å…‰èŠ’ */
        @keyframes winner-glow {
            0%, 100% { box-shadow: 0 0 10px rgba(34, 197, 94, 0.5), 0 0 20px rgba(34, 197, 94, 0.3); } 
            50% { box-shadow: 0 0 20px rgba(34, 197, 94, 0.8), 0 0 40px rgba(34, 197, 94, 0.6); } 
        }
        
        .winner-card {
            animation: winner-glow 1.5s infinite alternate;
            /* ç¡®ä¿è¾¹æ¡†é¢œè‰²åœ¨è·èƒœæ—¶ä¹Ÿæ›´æ˜¾çœ¼ */
            border-color: #22c55e !important; /* green-600 */
        }

        /* èµ›ç‚¹æç¤º (Game Point/Match Point) */
        .match-point-text {
            /* å°†èµ›ç‚¹æç¤ºå®šä½åˆ°å¡ç‰‡å³ä¸Šè§’ */
            @apply absolute top-0 right-0 m-2 px-3 py-1 bg-red-500 text-sm font-bold text-white rounded-full shadow-lg transform rotate-3;
        }
        
        /* è‡ªå®šä¹‰å¼€å…³æ ·å¼ */
        .toggle-switch {
            @apply appearance-none w-10 h-5 bg-gray-300 rounded-full cursor-pointer transition-colors duration-200 relative;
        }
        .toggle-switch:checked {
            @apply bg-indigo-500;
        }
        .toggle-switch::before {
            content: '';
            @apply absolute left-0.5 top-0.5 w-4 h-4 bg-white rounded-full transition-transform duration-200 shadow;
        }
        .toggle-switch:checked::before {
            transform: translateX(100%);
        }
        
        /* æŒ‰é’®æŒ‰å‹æ•ˆæœ (é€šç”¨) */
        .touch-effect:active {
            transform: scale(0.95);
        }
    </style>
</head>
<body class="min-h-screen flex items-center justify-center p-4">

    <div id="mainContainer" class="w-full max-w-4xl bg-white shadow-2xl rounded-3xl p-6 md:p-10 border border-gray-100">
        
        <div class="relative w-full mb-4">
            <h1 class="text-3xl md:text-4xl font-extrabold text-center text-gray-800">
                ğŸ† æ¯”èµ›è®¡åˆ†å™¨
            </h1>
            <button onclick="openSettingsModal()" class="absolute top-1/2 -translate-y-1/2 right-0 p-2 text-gray-500 hover:text-indigo-600 transition duration-150 rounded-full hover:bg-gray-100 focus:outline-none">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.5.344.978.535 1.455.578a1.724 1.724 0 001.065-2.572z" />
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                </svg>
            </button>
        </div>
        
        <div id="mainSettingsDisplay" class="w-full max-w-4xl text-center p-3 mb-8 bg-gray-100 rounded-xl border border-gray-200 shadow-inner">
            </div>

        <div class="flex flex-col md:flex-row gap-8 justify-between">
            
            <div id="player1Card" class="relative bg-blue-50 border-2 border-blue-200 rounded-2xl p-6 flex-1 shadow-xl">
                <input type="text" id="player1Name" value="é˜Ÿä¼ A" onchange="saveState(); updateLogDisplay();" class="w-full text-center text-2xl md:text-3xl font-semibold mb-4 bg-transparent border-b border-blue-300 focus:outline-none focus:border-blue-500 transition" />
                <div id="player1Score" class="text-7xl md:text-9xl font-extrabold text-center mb-6 text-blue-600 transition duration-300 ease-in-out">0</div>

                <div class="grid grid-cols-2 gap-4">
                    <button onclick="changeScore(1, -1)" class="score-control-btn py-6 text-3xl font-bold rounded-2xl shadow-xl bg-red-500 text-white hover:bg-red-600 transition duration-150 ease-in-out transform hover:scale-[1.02] active:scale-95 touch-effect">
                        -1
                    </button>
                    <button onclick="changeScore(1, 1)" class="score-control-btn py-6 text-3xl font-bold rounded-2xl shadow-xl bg-green-500 text-white hover:bg-green-600 transition duration-150 ease-in-out transform hover:scale-[1.02] active:scale-95 touch-effect">
                        +1
                    </button>
                </div>
            </div>

            <div class="hidden md:flex items-center">
                <div class="w-1 h-3/4 bg-gray-300 rounded-full"></div>
            </div>

            <div id="player2Card" class="relative bg-red-50 border-2 border-red-200 rounded-2xl p-6 flex-1 shadow-xl">
                <input type="text" id="player2Name" value="é˜Ÿä¼ B" onchange="saveState(); updateLogDisplay();" class="w-full text-center text-2xl md:text-3xl font-semibold mb-4 bg-transparent border-b border-red-300 focus:outline-none focus:border-red-500 transition" />
                <div id="player2Score" class="text-7xl md:text-9xl font-extrabold text-center mb-6 text-red-600 transition duration-300 ease-in-out">0</div>
                
                <div class="grid grid-cols-2 gap-4">
                    <button onclick="changeScore(2, -1)" class="score-control-btn py-6 text-3xl font-bold rounded-2xl shadow-xl bg-red-500 text-white hover:bg-red-600 transition duration-150 ease-in-out transform hover:scale-[1.02] active:scale-95 touch-effect">
                        -1
                    </button>
                    <button onclick="changeScore(2, 1)" class="score-control-btn py-6 text-3xl font-bold rounded-2xl shadow-xl bg-green-500 text-white hover:bg-green-600 transition duration-150 ease-in-out transform hover:scale-[1.02] active:scale-95 touch-effect">
                        +1
                    </button>
                </div>
            </div>
        </div>

        <div class="mt-8 pt-6 border-t border-gray-200 flex flex-col items-center gap-4">
            
            <div class="grid grid-cols-2 sm:grid-cols-3 w-full max-w-4xl gap-4"> 
                <button onclick="resetGame()" class="py-3 px-4 text-sm sm:text-lg font-semibold bg-yellow-500 text-white rounded-xl shadow-lg hover:bg-yellow-600 transition duration-200 ease-in-out">
                    ğŸ”„ å¼€å§‹/é‡ç½®
                </button>

                <button id="pauseResumeButton" onclick="togglePause()" class="py-3 px-4 text-sm sm:text-lg font-semibold bg-blue-500 text-white rounded-xl shadow-lg hover:bg-blue-600 transition duration-200 ease-in-out">
                    â¸ æš‚åœè®¡æ—¶
                </button>

                <button onclick="exportToTxt()" class="col-span-2 sm:col-span-1 py-3 px-4 text-sm sm:text-lg font-semibold bg-indigo-500 text-white rounded-xl shadow-lg hover:bg-indigo-600 transition duration-200 ease-in-out">
                    ğŸ“¥ å¯¼å‡ºè®°å½• (TXT)
                </button>
            </div>
            
            <div class="flex w-full max-w-lg items-center justify-center gap-4 mt-2">
                <button id="undoButton" onclick="undoLastAction()" class="py-2 px-4 text-sm font-semibold bg-red-400 text-white rounded-xl shadow-md hover:bg-red-500 transition duration-150">
                    â†© æ’¤é”€
                </button>
                
                <div id="timerDisplay" class="text-lg font-medium text-gray-700 flex-1 text-center">
                    </div>
            </div>

            <div id="logContainer" class="w-full max-w-4xl p-4 bg-gray-100 rounded-xl shadow-inner mt-4">
                </div>
        </div>
    </div>

    <div id="settingsModal" class="hidden fixed inset-0 bg-gray-900 bg-opacity-75 z-50 flex items-center justify-center transition-opacity duration-300">
        <div class="bg-white rounded-2xl p-6 md:p-8 w-11/12 max-w-md shadow-2xl transform scale-95 transition-transform duration-300">
            <div class="flex justify-between items-center border-b pb-3 mb-4">
                <h2 class="text-2xl font-bold text-gray-800">âš™ï¸ æ¯”èµ›è®¾ç½®</h2>
                <button onclick="closeSettingsModal()" class="text-gray-400 hover:text-gray-600">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                    </svg>
                </button>
            </div>
            
            <div id="gameControlSwitches" class="w-full flex flex-col gap-6 p-2">
                
                <div class="flex items-center justify-between gap-4 p-2 bg-indigo-50 rounded-xl border border-indigo-200">
                    <label for="toggleMatchPointMode" class="text-lg font-bold text-gray-800 whitespace-nowrap">æ˜¯å¦è®¾ç½®èµ›ç‚¹ (å¯ç”¨èƒœè´Ÿåˆ¤å®š):</label>
                    <input type="checkbox" id="toggleMatchPointMode" class="toggle-switch" onchange="checkGameStatus(); updateSettingsVisibility(); updateMainSettingsDisplay(); saveState();">
                </div>

                <div id="matchPointSettingsContainer" class="flex flex-col gap-4 pl-4 border-l-4 border-gray-200 hidden">
                    
                    <div class="flex items-center justify-between gap-4 p-2 bg-white border border-gray-200 rounded-xl shadow-sm">
                        <label for="targetScoreInput" class="text-lg font-semibold text-gray-700 whitespace-nowrap">èµ›ç‚¹ (æŠ¢å‡ åˆ†):</label>
                        <input type="number" id="targetScoreInput" value="13" min="1" onchange="checkGameStatus(); updateMainSettingsDisplay(); saveState();" class="w-20 p-2 text-center border-2 border-gray-300 rounded-lg focus:border-indigo-500 transition"/>
                    </div>

                    <div class="flex items-center justify-between gap-4 p-2 bg-white border border-gray-200 rounded-xl shadow-sm">
                        <label for="toggleMatchPoint" class="text-lg font-semibold text-gray-700 whitespace-nowrap">å¯ç”¨ä¸¤åˆ†åˆ¶è·èƒœ:</label>
                        <input type="checkbox" id="toggleMatchPoint" checked class="toggle-switch" onchange="checkGameStatus(); updateMainSettingsDisplay(); saveState();">
                    </div>

                </div>
            </div>
            
            <div class="mt-6 pt-4 border-t text-right">
                <button onclick="closeSettingsModal()" class="py-2 px-6 bg-indigo-500 text-white font-semibold rounded-xl hover:bg-indigo-600 transition">
                    å®Œæˆ
                </button>
            </div>
        </div>
    </div>
    
    <script>
        // --- æ ¸å¿ƒçŠ¶æ€å˜é‡ ---
        let score1 = 0; // é˜Ÿä¼ A çš„åˆ†æ•°
        let score2 = 0; // é˜Ÿä¼ B çš„åˆ†æ•°
        let log1 = [];
        let log2 = [];
        let name1 = "é˜Ÿä¼ A";
        let name2 = "é˜Ÿä¼ B";
        let isGameOver = false; // æ–°å¢ï¼šæ˜¯å¦å·²ç»“æŸæ¯”èµ›

        let startTime = null; // æ¯”èµ›ç»å¯¹å¼€å§‹æ—¶é—´æˆ³
        let timerInterval = null; // è®¡æ—¶å™¨ interval ID
        let cumulativePausedDuration = 0; // ç´¯è®¡æš‚åœæ—¶é•¿ (ms)
        let isPaused = false; // æ¸¸æˆæ˜¯å¦å¤„äºæš‚åœçŠ¶æ€
        let pausedAt = null; // è®°å½•æœ€è¿‘ä¸€æ¬¡æš‚åœçš„æ—¶é—´ç‚¹
        
        let audioContext = null; // Web Audio API Context

        // --- LOCAL STORAGE KEY ---
        const LOCAL_STORAGE_KEY = 'interactiveScoreCounterState';
        
        // --- NEW: æ•°æ®æŒä¹…åŒ–å‡½æ•° ---
        function saveState() {
            const state = {
                score1,
                score2,
                log1,
                log2,
                name1: document.getElementById('player1Name').value,
                name2: document.getElementById('player2Name').value,
                isGameOver,
                startTime,
                cumulativePausedDuration,
                isPaused,
                pausedAt,
                // ä¿å­˜è®¾ç½®
                targetScore: document.getElementById('targetScoreInput').value,
                matchPointEnabled: document.getElementById('toggleMatchPoint').checked,
                matchPointMode: document.getElementById('toggleMatchPointMode').checked,
            };
            try {
                localStorage.setItem(LOCAL_STORAGE_KEY, JSON.stringify(state));
            } catch (e) {
                console.error("Error saving to localStorage:", e);
            }
        }
        
        function loadState() {
            try {
                const stateString = localStorage.getItem(LOCAL_STORAGE_KEY);
                if (stateString) {
                    const state = JSON.parse(stateString);
                    
                    // æ ¸å¿ƒçŠ¶æ€å˜é‡
                    score1 = state.score1 ?? 0;
                    score2 = state.score2 ?? 0;
                    log1 = state.log1 ?? [];
                    log2 = state.log2 ?? [];
                    name1 = state.name1 ?? "é˜Ÿä¼ A";
                    name2 = state.name2 ?? "é˜Ÿä¼ B";
                    isGameOver = state.isGameOver ?? false;
                    
                    // è®¡æ—¶å™¨çŠ¶æ€
                    startTime = state.startTime ?? null;
                    cumulativePausedDuration = state.cumulativePausedDuration ?? 0;
                    isPaused = state.isPaused ?? false;
                    pausedAt = state.pausedAt ?? null; // æš‚åœæ—¶é—´ç‚¹ï¼Œç”¨äºæ¢å¤è®¡ç®—
                    
                    // UI & è®¾ç½®
                    document.getElementById('player1Name').value = name1;
                    document.getElementById('player2Name').value = name2;
                    
                    const targetScoreInput = document.getElementById('targetScoreInput');
                    const toggleMatchPoint = document.getElementById('toggleMatchPoint');
                    const toggleMatchPointMode = document.getElementById('toggleMatchPointMode');

                    if (targetScoreInput) targetScoreInput.value = state.targetScore ?? 13;
                    if (toggleMatchPoint) toggleMatchPoint.checked = state.matchPointEnabled ?? true;
                    if (toggleMatchPointMode) toggleMatchPointMode.checked = state.matchPointMode ?? false;

                    // æ¢å¤æ˜¾ç¤º
                    updateScoreDisplay(1);
                    updateScoreDisplay(2);
                    updateLogDisplay();
                    updateSettingsVisibility();
                    
                    // æ¢å¤è®¡æ—¶å™¨è¿è¡ŒçŠ¶æ€ (å¦‚æœéœ€è¦)
                    if (startTime !== null) {
                        if (!isPaused && !isGameOver) {
                            startTimer();
                        } else {
                            // ç¡®ä¿æš‚åœ/ç»“æŸçŠ¶æ€çš„æ˜¾ç¤ºæ˜¯æ­£ç¡®çš„
                            updateTimerDisplay(); 
                            if (isPaused) {
                                const pauseButton = document.getElementById('pauseResumeButton');
                                pauseButton.textContent = "â–¶ ç»§ç»­è®¡æ—¶";
                                pauseButton.classList.remove('bg-blue-500', 'hover:bg-blue-600');
                                pauseButton.classList.add('bg-green-600', 'hover:bg-green-700');
                            }
                        }
                    }
                    
                    // æ¢å¤è·èƒœé«˜äº®å’Œèµ›ç‚¹æç¤º
                    checkGameStatus();
                    
                    showCustomMessage("æ¸¸æˆçŠ¶æ€å·²ä»æœ¬åœ°å­˜å‚¨åŠ è½½ã€‚", "bg-indigo-100 border-indigo-500 text-indigo-700");
                    return true;
                }
            } catch (e) {
                console.error("Error loading state from localStorage:", e);
            }
            return false;
        }

        /**
         * é‡ç½®æœ¬åœ°çŠ¶æ€å˜é‡å’Œ UIã€‚
         */
        function resetLocalState() {
            score1 = 0;
            score2 = 0;
            log1 = []; 
            log2 = []; 
            name1 = 'é˜Ÿä¼ A';
            name2 = 'é˜Ÿä¼ B';
            isGameOver = false; // é‡ç½®æ¯”èµ›çŠ¶æ€
            
            cumulativePausedDuration = 0;
            isPaused = false;
            startTime = null; // é‡ç½®æ—¶è®¾ä¸º nullï¼Œç›´åˆ°ç¬¬ä¸€æ¬¡å¾—åˆ†æ‰å¼€å§‹è®¡æ—¶
            pausedAt = null;

            if (timerInterval) clearInterval(timerInterval);

            // é‡ç½® UI
            document.getElementById('player1Name').value = name1;
            document.getElementById('player2Name').value = name2;
            
            // --- NEW SETTINGS RESET ---
            // æ¢å¤é»˜è®¤èµ›ç‚¹ä¸º 13
            document.getElementById('targetScoreInput').value = 13; 
            document.getElementById('toggleMatchPoint').checked = true; // ä¸¤åˆ†åˆ¶é»˜è®¤å¼€å¯
            // CHANGED: èµ›ç‚¹æ¨¡å¼é»˜è®¤å…³é—­ (false)
            document.getElementById('toggleMatchPointMode').checked = false; // èµ›ç‚¹æ¨¡å¼é»˜è®¤å…³é—­
            
            saveState(); // *** ä¿å­˜é‡ç½®åçš„çŠ¶æ€ ***
            
            updateSettingsVisibility(); // é‡ç½®åæ›´æ–°å¯è§æ€§
            updateMainSettingsDisplay(); // NEW: é‡ç½®åæ›´æ–°ä¸»ç•Œé¢æ˜¾ç¤º
            // --------------------------
            
            updateScoreDisplay(1);
            updateScoreDisplay(2);
            updateLogDisplay();
            updateTimerDisplay(); // æ›´æ–°æ˜¾ç¤ºä¸º 'æœªå¼€å§‹'

            const pauseButton = document.getElementById('pauseResumeButton');
            pauseButton.textContent = "â¸ æš‚åœè®¡æ—¶";
            pauseButton.classList.remove('bg-green-600', 'hover:bg-green-700');
            pauseButton.classList.add('bg-blue-500', 'hover:bg-blue-600');
            
            // æ¸…é™¤è·èƒœé«˜äº®å’Œèµ›ç‚¹æç¤º
            document.getElementById('player1Card').classList.remove('winner-card');
            document.getElementById('player2Card').classList.remove('winner-card');
            const existingTags = document.querySelectorAll('.match-point-text');
            existingTags.forEach(tag => tag.remove());
            
            showCustomMessage("æ¸¸æˆå·²é‡ç½®ã€‚", "bg-yellow-100 border-yellow-500 text-yellow-700");
        }
        
        /**
         * æ’­æ”¾å¾—åˆ†æˆ–æ‰£åˆ†éŸ³æ•ˆ (Web Audio API)ã€‚
         */
        function playScoreSound(frequency = 660, duration = 0.05, type = 'sine') {
            if (typeof AudioContext !== 'undefined' || typeof webkitAudioContext !== 'undefined') {
                audioContext = audioContext || new (window.AudioContext || window.webkitAudioContext)();
                
                // --- ç§»åŠ¨ç«¯ä¿®å¤ï¼šå¦‚æœéŸ³é¢‘ä¸Šä¸‹æ–‡è¢«æš‚åœï¼Œåˆ™å°è¯•æ¢å¤ ---
                if (audioContext.state === 'suspended') {
                    // å¿…é¡»å°†æ¢å¤æ“ä½œæ”¾åœ¨ç”¨æˆ·æ‰‹åŠ¿å†… (å³ changeScore è°ƒç”¨)
                    audioContext.resume().then(() => {
                        _createAndPlayOscillator(audioContext, frequency, duration, type);
                    }).catch(err => {
                        console.error("Failed to resume AudioContext:", err);
                    });
                } else {
                    _createAndPlayOscillator(audioContext, frequency, duration, type);
                }
            }
        }
        
        /**
         * æ ¸å¿ƒéŸ³æ•ˆç”Ÿæˆé€»è¾‘ã€‚
         */
        function _createAndPlayOscillator(context, frequency, duration, type) {
            const oscillator = context.createOscillator();
            const gainNode = context.createGain();
            
            oscillator.connect(gainNode);
            gainNode.connect(context.destination);

            oscillator.type = type;
            oscillator.frequency.setValueAtTime(frequency, context.currentTime);

            // Fade out
            gainNode.gain.setValueAtTime(0.3, context.currentTime);
            gainNode.gain.exponentialRampToValueAtTime(0.00001, context.currentTime + duration);

            oscillator.start();
            oscillator.stop(context.currentTime + duration);
        }

        /** æ ¼å¼åŒ–æ¯«ç§’æ•°ä¸º å¤©/æ—¶/åˆ†/ç§’ çš„å­—ç¬¦ä¸² */
        function formatDuration(ms) {
            if (ms < 0) ms = 0;
            const totalSeconds = Math.floor(ms / 1000);
            
            const days = Math.floor(totalSeconds / (3600 * 24));
            const hours = Math.floor((totalSeconds % (3600 * 24)) / 3600);
            const minutes = Math.floor((totalSeconds % 3600) / 60);
            const seconds = totalSeconds % 60;

            let result = '';
            if (days > 0) result += `${days}å¤©`;
            result += `${String(hours).padStart(2, '0')}æ—¶`;
            result += `${String(minutes).padStart(2, '0')}åˆ†`;
            result += `${String(seconds).padStart(2, '0')}ç§’`;
            
            return result;
        }
        
        /** æ ¼å¼åŒ–æ—¶é—´æˆ³ä¸º YYYY/MM/DD HH:MM:SS å­—ç¬¦ä¸² */
        function formatDateTime(timestamp) {
            if (timestamp === null) return 'N/A';
            const date = new Date(timestamp);
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            const hours = String(date.getHours()).padStart(2, '0');
            const minutes = String(date.getMinutes()).padStart(2, '0');
            const seconds = String(date.getSeconds()).padStart(2, '0');
            return `${year}/${month}/${day} ${hours}:${minutes}:${seconds}`;
        }
        
        /**
         * å¯åŠ¨å®æ—¶è®¡æ—¶å™¨ã€‚
         */
        function startTimer() {
            if (timerInterval) {
                clearInterval(timerInterval);
            }
            
            if (startTime !== null && !isPaused) {
                updateTimerDisplay();
                timerInterval = setInterval(updateTimerDisplay, 1000);
            } else {
                updateTimerDisplay();
            }
        }
        
        /**
         * æš‚åœæˆ–ç»§ç»­è®¡æ—¶ã€‚
         */
        function togglePause() {
            const button = document.getElementById('pauseResumeButton');

            if (startTime === null) {
                showCustomMessage("è¯·å…ˆå¼€å§‹è®¡åˆ†æˆ–é‡ç½®æ¸¸æˆä»¥å¯åŠ¨è®¡æ—¶å™¨ã€‚", "bg-yellow-100 border-yellow-500 text-yellow-700");
                return;
            }
            
            // åªæœ‰åœ¨å¯ç”¨èµ›ç‚¹æ¨¡å¼ä¸”æ¯”èµ›å·²ç»“æŸæ—¶æ‰é˜»æ­¢æš‚åœ
            const matchPointMode = document.getElementById('toggleMatchPointMode')?.checked ?? true;
            if (isGameOver && matchPointMode) {
                showCustomMessage("æ¯”èµ›å·²ç»“æŸï¼Œè¯·å…ˆé‡ç½®ã€‚", "bg-red-100 border-red-500 text-red-700");
                return;
            }

            if (isPaused) {
                // Resume
                const pausedDuration = Date.now() - pausedAt;
                cumulativePausedDuration += pausedDuration;
                isPaused = false;
                pausedAt = null; // æ¸…é™¤æš‚åœæ—¶é—´ç‚¹
                button.textContent = "â¸ æš‚åœè®¡æ—¶";
                button.classList.remove('bg-green-600', 'hover:bg-green-700');
                button.classList.add('bg-blue-500', 'hover:bg-blue-600');
                startTimer(); // Restart interval
                showCustomMessage("è®¡æ—¶å·²ç»§ç»­ã€‚", "bg-blue-100 border-blue-500 text-blue-700");
            } else {
                // Pause
                if (timerInterval) clearInterval(timerInterval);
                isPaused = true;
                pausedAt = Date.now();
                button.textContent = "â–¶ ç»§ç»­è®¡æ—¶";
                button.classList.remove('bg-blue-500', 'hover:bg-blue-600');
                button.classList.add('bg-green-600', 'hover:bg-green-700');
                updateTimerDisplay(); // Update display immediately to reflect 'Paused' status
                showCustomMessage("è®¡æ—¶å·²æš‚åœã€‚", "bg-yellow-100 border-yellow-500 text-yellow-700");
            }
            saveState(); // *** ä¿å­˜è®¡æ—¶çŠ¶æ€ ***
        }

        /**
         * è®¡ç®—å¹¶æ›´æ–°è®¡æ—¶å™¨æ˜¾ç¤ºã€‚
         */
        function updateTimerDisplay() {
            if (startTime === null) {
                document.getElementById('timerDisplay').textContent = "æ¸¸æˆçŠ¶æ€: æœªå¼€å§‹";
                clearInterval(timerInterval);
                timerInterval = null;
                return;
            }

            // æ€»æ¸¸ç©æ—¶é•¿ = (å½“å‰æ—¶é—´ - ç»å¯¹å¼€å§‹æ—¶é—´) - ç´¯è®¡æš‚åœæ—¶é•¿
            let durationMs;
            
            if (isPaused || isGameOver) {
                // å¦‚æœå·²æš‚åœæˆ–å·²ç»“æŸï¼Œä½¿ç”¨æœ€è¿‘ä¸€æ¬¡æš‚åœ/ç»“æŸæ—¶é—´
                const referenceTime = pausedAt || (isGameOver ? Date.now() : Date.now()); 
                durationMs = referenceTime - startTime - cumulativePausedDuration;
                const duration = formatDuration(durationMs);
                document.getElementById('timerDisplay').textContent = isGameOver ? `å·²ç»“æŸ (æ€»æ—¶é•¿: ${duration})` : `å·²æš‚åœ (å·²ç©: ${duration})`;
                return;
            }
            
            durationMs = (Date.now() - startTime) - cumulativePausedDuration;
            const duration = formatDuration(durationMs);
            document.getElementById('timerDisplay').textContent = `å·²æŒç»­è®¡æ—¶: ${duration}`;
        }


        /**
         * æ›´æ–°æŒ‡å®šé˜Ÿä¼çš„åˆ†æ•°æ˜¾ç¤ºã€‚
         */
        function updateScoreDisplay(player) {
            const scoreElement = document.getElementById(`player${player}Score`);
            const currentScore = player === 1 ? score1 : score2;
            
            scoreElement.textContent = currentScore;
            scoreElement.classList.add('scale-105');
            setTimeout(() => {
                scoreElement.classList.remove('scale-105');
            }, 150);
        }

        /**
         * æ›´æ–°å¾—åˆ†è®°å½•åˆ—è¡¨ã€‚
         */
        function updateLogDisplay() {
            name1 = document.getElementById('player1Name').value;
            name2 = document.getElementById('player2Name').value;
            const logContainer = document.getElementById('logContainer');

            // åˆå¹¶å¹¶æŒ‰æ—¶é—´æˆ³é™åºæ’åˆ— (æœ€æ–°çš„åœ¨æœ€ä¸Šé¢)
            const combinedLog = [
                ...log1.map(item => ({ ...item, player: 1, name: name1, color: 'text-blue-600' })),
                ...log2.map(item => ({ ...item, player: 2, name: name2, color: 'text-red-600' }))
            ].sort((a, b) => {
                return a.timestamp - b.timestamp;
            }).reverse();
            
            const recentLog = combinedLog.slice(0, 15);

            let logHtml = `<h2 class="text-xl font-bold text-gray-700 mb-4 text-center">æœ€è¿‘ ${recentLog.length} æ¡å¾—åˆ†è®°å½•</h2>`;
            
            if (recentLog.length === 0) {
                logHtml += '<p class="text-gray-500 italic text-center">æš‚æ— è®°å½•ã€‚</p>';
            } else {
                logHtml += '<ul class="space-y-2">';
                recentLog.forEach(entry => {
                    const action = entry.amount > 0 ? 'å¾—åˆ†' : 'æ‰£åˆ†';
                    const amountText = entry.amount > 0 ? `+${entry.amount}` : `${entry.amount}`;
                    const colorClass = entry.amount > 0 ? 'text-green-600' : 'text-red-600';
                    
                    logHtml += `
                        <li class="flex justify-between items-center p-3 bg-white rounded-lg shadow-sm border-l-4 ${entry.player === 1 ? 'border-blue-500' : 'border-red-500'}">
                            <span class="text-sm font-medium text-gray-500 w-1/4 md:w-auto">${entry.time}</span>
                            <span class="${entry.color} font-bold w-1/4 md:w-auto truncate">${entry.name}</span>
                            <span class="${colorClass} font-semibold w-1/4 text-right">${action} ${amountText}</span>
                            <span class="text-sm text-gray-700 w-1/4 text-right">æ¯”åˆ†: ${entry.scoreA} - ${entry.scoreB}</span>
                        </li>
                    `;
                });
                logHtml += '</ul>';
            }

            logContainer.innerHTML = logHtml;
        }

        /**
         * æ”¹å˜æŒ‡å®šé˜Ÿä¼çš„åˆ†æ•°ã€‚
         */
        function changeScore(player, amount) {
            // è·å–æ–°çš„ä¸»å¼€å…³çŠ¶æ€
            const matchPointMode = document.getElementById('toggleMatchPointMode')?.checked ?? false; // é»˜è®¤æ”¹ä¸º false
            
            // æ£€æŸ¥æ˜¯å¦åœ¨èµ›ç‚¹æ¨¡å¼ä¸‹å¹¶ä¸”æ¯”èµ›å·²ç»“æŸï¼Œå¦‚æœå·²ç»“æŸä¸”åœ¨èµ›ç‚¹æ¨¡å¼ä¸‹ï¼Œç¦æ­¢å¾—åˆ†
            if (isGameOver && matchPointMode) {
                showCustomMessage("æ¯”èµ›å·²ç»“æŸï¼Œè¯·ç‚¹å‡» 'å¼€å§‹/é‡ç½®' é‡æ–°å¼€å§‹ã€‚", "bg-red-100 border-red-500 text-red-700");
                playScoreSound(110, 0.2, 'square');
                return;
            }
            
            // å¦‚æœåœ¨æ— é™æ¨¡å¼ä¸‹å¾—åˆ†ï¼Œä¸”ä¹‹å‰æ ‡è®°äº†ç»“æŸ (å¯èƒ½æ˜¯ä»èµ›ç‚¹æ¨¡å¼åˆ‡æ¢è¿‡æ¥)ï¼Œç°åœ¨åº”è¯¥å–æ¶ˆç»“æŸçŠ¶æ€å¹¶ç»§ç»­è®¡æ—¶
            if (isGameOver && !matchPointMode) {
                isGameOver = false;
                if(isPaused) togglePause(); // å¦‚æœä¹‹å‰æš‚åœäº†ï¼Œè‡ªåŠ¨ç»§ç»­
                else startTimer();
            }

            const now = new Date();
            const wasStartTimeNull = (startTime === null);

            if (wasStartTimeNull) {
                startTime = now.getTime();
                cumulativePausedDuration = 0;
                isPaused = false;
                startTimer();
            } else if (isPaused) {
                // å¦‚æœåœ¨æš‚åœçŠ¶æ€ä¸‹è®¡åˆ†ï¼Œè‡ªåŠ¨è§£é™¤æš‚åœå¹¶ç»§ç»­è®¡æ—¶
                togglePause(); // togglePause ä¼šå¤„ç†è®¡æ—¶å™¨çš„æ¢å¤å’Œ saveState
                // æ³¨æ„ï¼šç”±äº togglePause å†…éƒ¨è°ƒç”¨äº† saveStateï¼Œè¿™é‡Œä¸éœ€è¦é‡å¤è°ƒç”¨
            }
            
            name1 = document.getElementById('player1Name').value;
            name2 = document.getElementById('player2Name').value;
            const timeString = now.toLocaleTimeString('zh-CN', { hour: '2-digit', minute: '2-digit', second: '2-digit' });
            
            if (player === 1) {
                score1 += amount;
                if (score1 < 0) score1 = 0;
                log1.push({ time: timeString, amount: amount, scoreA: score1, scoreB: score2, timestamp: now.getTime() });
            } else if (player === 2) {
                score2 += amount;
                if (score2 < 0) score2 = 0;
                log2.push({ time: timeString, amount: amount, scoreA: score1, scoreB: score2, timestamp: now.getTime() });
            }
            
            playScoreSound(amount > 0 ? 660 : 330); // æ’­æ”¾éŸ³æ•ˆï¼šé«˜é¢‘å¾—åˆ†ï¼Œä½é¢‘æ‰£åˆ†

            updateScoreDisplay(player);
            updateLogDisplay();
            
            // æ£€æŸ¥æ¸¸æˆçŠ¶æ€
            checkGameStatus();
            
            // å¦‚æœ togglePause æ²¡æœ‰è¢«è°ƒç”¨ï¼Œè¿™é‡Œæ‰‹åŠ¨ä¿å­˜çŠ¶æ€
            if (!isPaused) saveState();
        }
        
        /**
         * æ’¤é”€æœ€åä¸€æ¬¡æ“ä½œã€‚
         */
        function undoLastAction() {
            // åˆå¹¶æ‰€æœ‰æ—¥å¿—å¹¶æŒ‰æ—¶é—´æˆ³é™åºæ’åˆ— (æœ€æ–°çš„åœ¨æœ€ä¸Šé¢)
            const combinedLog = [
                ...log1.map(item => ({ ...item, isPlayer1: true, logArray: log1, name: document.getElementById('player1Name').value })),
                ...log2.map(item => ({ ...item, isPlayer1: false, logArray: log2, name: document.getElementById('player2Name').value }))
            ].sort((a, b) => b.timestamp - a.timestamp); 

            if (combinedLog.length === 0) {
                showCustomMessage("æ²¡æœ‰å¯æ’¤é”€çš„æ“ä½œã€‚", "bg-red-100 border-red-500 text-red-700");
                return;
            }

            // å¦‚æœæ¸¸æˆç»“æŸï¼Œæ’¤é”€æ“ä½œåº”èƒ½é‡æ–°æ¿€æ´»æ¸¸æˆ
            if (isGameOver) {
                isGameOver = false;
                startTimer();
            }

            const lastEntry = combinedLog[0];
            const logArrayToModify = lastEntry.isPlayer1 ? log1 : log2;
            
            // æ‰¾åˆ°æœ€åä¸€ä¸ªåŒ¹é…çš„æ¡ç›® (æŒ‰æ—¶é—´æˆ³)
            const indexToRemove = logArrayToModify.findIndex(item => 
                item.timestamp === lastEntry.timestamp && 
                item.amount === lastEntry.amount && 
                item.scoreA === lastEntry.scoreA && 
                item.scoreB === lastEntry.scoreB
            );

            if (indexToRemove > -1) {
                // ç§»é™¤æ—¥å¿—æ¡ç›®
                logArrayToModify.splice(indexToRemove, 1);
                
                // å›æ»šåˆ†æ•°
                if (lastEntry.isPlayer1) {
                    score1 -= lastEntry.amount;
                    if (score1 < 0) score1 = 0;
                    updateScoreDisplay(1);
                } else {
                    score2 -= lastEntry.amount;
                    if (score2 < 0) score2 = 0;
                    updateScoreDisplay(2);
                }
                
                playScoreSound(220); // æ’¤é”€éŸ³æ•ˆ
                showCustomMessage(`å·²æ’¤é”€æ“ä½œï¼š${lastEntry.name} ${lastEntry.amount > 0 ? '+' : ''}${lastEntry.amount}`, "bg-green-100 border-green-500 text-green-700");

                // å¦‚æœæ—¥å¿—æ¸…ç©ºï¼Œé‡ç½®è®¡æ—¶å™¨çŠ¶æ€
                if (log1.length === 0 && log2.length === 0) {
                    resetLocalState();
                } else {
                    // æ’¤é”€åé‡æ–°æ£€æŸ¥èµ›ç‚¹çŠ¶æ€
                    checkGameStatus(); 
                }

                updateLogDisplay();
                saveState(); // *** æ’¤é”€åä¿å­˜çŠ¶æ€ ***
            } else {
                showCustomMessage("æ’¤é”€å¤±è´¥ï¼šæœªæ‰¾åˆ°åŒ¹é…çš„æ—¥å¿—æ¡ç›®ã€‚", "bg-red-100 border-red-500 text-red-700");
            }
        }
        
        /**
         * æ§åˆ¶èµ›ç‚¹ç›¸å…³çš„è®¾ç½®é¡¹çš„å¯è§æ€§ (ä»…é’ˆå¯¹è®¾ç½®æ¨¡æ€æ¡†å†…éƒ¨)ã€‚
         */
        function updateSettingsVisibility() {
            const modeToggle = document.getElementById('toggleMatchPointMode');
            const settingsContainer = document.getElementById('matchPointSettingsContainer');
            
            if (modeToggle && settingsContainer) {
                if (modeToggle.checked) {
                    settingsContainer.classList.remove('hidden');
                } else {
                    settingsContainer.classList.add('hidden');
                }
            }
            // ä¸éœ€è¦ saveStateï¼Œå› ä¸º onchange äº‹ä»¶å·²ç»å¤„ç†
        }

        /**
         * NEW: æ›´æ–°ä¸»ç•Œé¢èµ›ç‚¹è®¾ç½®çš„æ˜¾ç¤ºã€‚
         */
        function updateMainSettingsDisplay() {
            const display = document.getElementById('mainSettingsDisplay');
            const modeToggle = document.getElementById('toggleMatchPointMode');
            
            if (!display || !modeToggle) return; 

            const isMatchPointMode = modeToggle.checked;
            
            if (isMatchPointMode) {
                const targetScoreInput = document.getElementById('targetScoreInput');
                const matchPointToggle = document.getElementById('toggleMatchPoint');
                
                const targetScore = targetScoreInput ? targetScoreInput.value : 'N/A';
                const winByTwo = matchPointToggle && matchPointToggle.checked;
                
                let winCondition = `æŠ¢ ${targetScore} åˆ†`;
                if (winByTwo) {
                    winCondition += " (éœ€é¢†å…ˆ 2 åˆ†)";
                } else {
                    winCondition += " (ä¸è®¾ä¸¤åˆ†åˆ¶)";
                }

                let statusColor = isGameOver ? 'text-green-600' : 'text-indigo-600';
                let statusText = isGameOver ? 'âœ… æ¯”èµ›å·²ç»“æŸ' : 'ğŸ”µ èµ›ç‚¹æ¨¡å¼ (å¯ç”¨èƒœè´Ÿåˆ¤å®š)';

                display.innerHTML = `
                    <p class="text-xl font-bold ${statusColor} mb-1">${statusText}</p>
                    <p class="text-md font-medium text-gray-700">è·èƒœæ¡ä»¶: ${winCondition}</p>
                `;
                display.classList.remove('hidden');

            } else {
                // Unlimited Scoring Mode (No Match Point)
                let statusColor = 'text-gray-600';
                let statusText = 'ğŸŸ¡ æ— é™è®°åˆ†æ¨¡å¼ (ä¸åˆ¤æ–­èƒœè´Ÿ)';
                
                display.innerHTML = `
                    <p class="text-xl font-bold ${statusColor} mb-1">${statusText}</p>
                    <p class="text-md font-medium text-gray-700">åˆ†æ•°è¾¾åˆ°ç›®æ ‡åæ¸¸æˆä¸ä¼šè‡ªåŠ¨ç»“æŸã€‚</p>
                `;
                display.classList.remove('hidden');
            }
        }


        /**
         * æ£€æŸ¥å½“å‰åˆ†æ•°æ˜¯å¦è¾¾åˆ°èµ›ç‚¹æˆ–æ¯”èµ›ç»“æŸã€‚
         */
        function checkGameStatus() {
            // 1. æ¸…é™¤ç°æœ‰é«˜äº®/æŒ‡ç¤ºå™¨
            document.getElementById('player1Card').classList.remove('winner-card');
            document.getElementById('player2Card').classList.remove('winner-card');
            const existingTags = document.querySelectorAll('.match-point-text');
            existingTags.forEach(tag => tag.remove());
            
            const targetScoreInput = document.getElementById('targetScoreInput');
            const toggleMatchPoint = document.getElementById('toggleMatchPoint');
            const toggleMatchPointMode = document.getElementById('toggleMatchPointMode'); 

            // æ£€æŸ¥å…ƒç´ æ˜¯å¦å­˜åœ¨ï¼Œé˜²æ­¢åœ¨é¡µé¢åŠ è½½å‰è°ƒç”¨å‡ºé”™
            if (!targetScoreInput || !toggleMatchPoint || !toggleMatchPointMode) {
                 return;
            }

            const matchPointMode = toggleMatchPointMode.checked; // è·å–ä¸»å¼€å…³çŠ¶æ€
            
            // --- æ ¸å¿ƒé€»è¾‘: å¦‚æœæœªè®¾ç½®èµ›ç‚¹æ¨¡å¼ (MatchPointMode = OFF)ï¼Œåˆ™è¿›è¡Œæ— é™è®°åˆ†ï¼Œä¸åˆ¤æ–­èƒœè´Ÿ ---
            if (!matchPointMode) {
                 isGameOver = false; // ç¡®ä¿å³ä½¿ä¹‹å‰ç»“æŸï¼Œç°åœ¨ä¹Ÿå¯ä»¥ç»§ç»­
                 if (startTime !== null && !isPaused) startTimer(); // ç¡®ä¿è®¡æ—¶å™¨èƒ½ç»§ç»­
                 updateMainSettingsDisplay(); // NEW: æ›´æ–°æ˜¾ç¤ºçŠ¶æ€
                 return; 
            }
            // --- èµ›ç‚¹æ¨¡å¼å¼€å¯æ—¶ï¼Œç»§ç»­æ‰§è¡Œä»¥ä¸‹è·èƒœé€»è¾‘ ---

            const targetScore = parseInt(targetScoreInput.value, 10);
            const matchPointEnabled = toggleMatchPoint.checked; 
            
            if (isNaN(targetScore) || targetScore <= 0) return; 

            const scoreA = score1;
            const scoreB = score2;
            
            let winner = 0;
            
            if (matchPointEnabled) {
                // å¯ç”¨ä¸¤åˆ†åˆ¶ï¼šéœ€è¦è¾¾åˆ°ç›®æ ‡åˆ†æ•°ä¸”é¢†å…ˆè‡³å°‘ 2 åˆ† (å¸¸è§çš„æ’çƒ/ç¾½æ¯›çƒ/ä¹’ä¹“çƒè§„åˆ™)
                const winByTwo = (Math.abs(scoreA - scoreB) >= 2);
                
                if (scoreA >= targetScore && winByTwo) {
                    winner = 1;
                } else if (scoreB >= targetScore && winByTwo) {
                    winner = 2;
                } else {
                    // èµ›ç‚¹æç¤ºé€»è¾‘ 
                    if (scoreA >= targetScore - 1 && scoreB < scoreA && scoreB < targetScore - 1) {
                         // A é¢†å…ˆï¼Œä¸” A ä»…å·®ä¸€åˆ†è·èƒœ (å¦‚ 12-10, ç›®æ ‡ 13)
                         updateGamePointIndicators(1);
                    } else if (scoreB >= targetScore - 1 && scoreA < scoreB && scoreA < targetScore - 1) {
                         // B é¢†å…ˆï¼Œä¸” B ä»…å·®ä¸€åˆ†è·èƒœ (å¦‚ 10-12, ç›®æ ‡ 13)
                         updateGamePointIndicators(2);
                    } else if (scoreA >= targetScore - 1 && scoreB >= targetScore - 1 && Math.abs(scoreA - scoreB) === 1) {
                        // å å…ˆ/èµ›æœ«ç‚¹ï¼šæ¯”åˆ†èƒ¶ç€ï¼Œé¢†å…ˆä¸€æ–¹è·å¾—èµ›ç‚¹ (å¦‚ 13-12, ç›®æ ‡ 13)
                        if (scoreA > scoreB) {
                            updateGamePointIndicators(1, true); // å å…ˆ/èµ›ç‚¹
                        } else {
                            updateGamePointIndicators(2, true); // å å…ˆ/èµ›ç‚¹
                        }
                    }
                }

            } else {
                // ç¦ç”¨ä¸¤åˆ†åˆ¶ï¼šåªéœ€è¾¾åˆ°ç›®æ ‡åˆ†æ•°å³å¯è·èƒœ (First to Target)
                if (scoreA >= targetScore && scoreA > scoreB) {
                    winner = 1;
                } else if (scoreB >= targetScore && scoreB > scoreA) {
                    winner = 2;
                }
                // åœ¨éä¸¤åˆ†åˆ¶æ¨¡å¼ä¸‹ï¼Œä¸æ˜¾ç¤ºâ€œèµ›ç‚¹â€æç¤º
            }


            if (winner !== 0) {
                highlightWinner(winner);
            }
            
            updateMainSettingsDisplay(); // NEW: æ¯æ¬¡æ£€æŸ¥çŠ¶æ€åéƒ½æ›´æ–°ä¸»ç•Œé¢æ˜¾ç¤º (åŒ…æ‹¬æ¯”èµ›æ˜¯å¦ç»“æŸ)
            saveState(); // *** æ£€æŸ¥çŠ¶æ€åä¿å­˜çŠ¶æ€ (ç‰¹åˆ«æ˜¯ isGameOver) ***
        }

        /**
         * çªå‡ºæ˜¾ç¤ºè·èƒœçš„é˜Ÿä¼å¹¶ç»“æŸè®¡æ—¶ã€‚
         */
        function highlightWinner(player) {
            isGameOver = true; // æ ‡è®°æ¯”èµ›ç»“æŸ
            if (timerInterval) clearInterval(timerInterval); // åœæ­¢è®¡æ—¶å™¨æ˜¾ç¤ºæ›´æ–°
            pausedAt = Date.now(); // è®°å½•ç»“æŸæ—¶é—´ç‚¹

            const winningCard = document.getElementById(`player${player}Card`);
            winningCard.classList.add('winner-card');
            
            const winningName = document.getElementById(`player${player}Name`).value;
            
            showCustomMessage(`ğŸ‰ æ­å–œ ${winningName} èµ¢å¾—æ¯”èµ›! æœ€ç»ˆæ¯”åˆ† ${score1} - ${score2}`, "bg-green-100 border-green-700 text-green-800");
            updateTimerDisplay(); // æ›´æ–°æ˜¾ç¤ºä¸º 'å·²ç»“æŸ'
            saveState(); // *** è·èƒœåä¿å­˜çŠ¶æ€ ***
        }

        /**
         * æ›´æ–°èµ›ç‚¹ (Match Point) æç¤ºã€‚
         */
        function updateGamePointIndicators(player, isDeucePoint = false) {
            // å…ˆç§»é™¤å¦ä¸€é˜Ÿçš„æç¤º
            const otherPlayer = player === 1 ? 2 : 1;
            const otherCard = document.getElementById(`player${otherPlayer}Card`);
            const otherTags = otherCard.querySelectorAll('.match-point-text');
            otherTags.forEach(tag => tag.remove());
            
            // Create a 'Match Point' tag on the specified player's card
            const card = document.getElementById(`player${player}Card`);
            
            // é¿å…é‡å¤æ·»åŠ 
            if (card.querySelector('.match-point-text')) return;

            const tag = document.createElement('span');
            tag.className = 'match-point-text';
            tag.textContent = isDeucePoint ? 'å å…ˆ/èµ›ç‚¹' : 'èµ›ç‚¹';
            card.appendChild(tag);
            
            const playerName = document.getElementById(`player${player}Name`).value;
            // åªæœ‰å½“ä¸æ˜¯å¹³åˆ†èƒ¶ç€æ—¶çš„å å…ˆç‚¹æ‰æ’­æ”¾å¤§æç¤º
            if (!isDeucePoint || score1 === score2 + 1 || score2 === score1 + 1) {
                showCustomMessage(`ğŸ”¥ ${playerName} è¾¾åˆ°èµ›ç‚¹ï¼`, "bg-red-100 border-red-500 text-red-700");
            }
            // ä¸éœ€è¦ saveStateï¼Œå› ä¸º checkGameStatus å·²åœ¨å¾—åˆ†åè°ƒç”¨
        }

        /**
         * æ‰“å¼€è®¾ç½®æ¨¡æ€æ¡†ã€‚
         */
        function openSettingsModal() {
            const modal = document.getElementById('settingsModal');
            modal.classList.remove('hidden');
            updateSettingsVisibility(); // ç¡®ä¿æ‰“å¼€æ—¶å¯è§æ€§æ­£ç¡®
            // ç¡®ä¿å†…å®¹ä»å°ç¼©æ”¾è‡³æ­£å¸¸å¤§å°
            setTimeout(() => {
                modal.querySelector('.bg-white').classList.remove('scale-95');
                modal.classList.add('opacity-100');
            }, 10);
            // openSettingsModal ä¸æ”¹å˜çŠ¶æ€ï¼Œä¸éœ€è¦ saveState
        }

        /**
         * å…³é—­è®¾ç½®æ¨¡æ€æ¡†ã€‚
         */
        function closeSettingsModal() {
            const modal = document.getElementById('settingsModal');
            // ç¡®ä¿å†…å®¹ä»å°ç¼©æ”¾è‡³æ­£å¸¸å¤§å°
            modal.querySelector('.bg-white').classList.add('scale-95');
            modal.classList.remove('opacity-100');
            setTimeout(() => {
                modal.classList.add('hidden');
            }, 300); // Wait for transition

            // NEW: å…³é—­è®¾ç½®åï¼Œé‡æ–°æ£€æŸ¥æ¸¸æˆçŠ¶æ€å¹¶æ›´æ–°ä¸»ç•Œé¢æ˜¾ç¤º
            checkGameStatus();
            updateMainSettingsDisplay();
            // åœ¨è®¾ç½®é¡¹çš„ onchange äº‹ä»¶ä¸­å·²è°ƒç”¨ saveState()ï¼Œè¿™é‡Œä¸å†é‡å¤
        }


        /**
         * å¯¼å‡ºæ‰€æœ‰åˆ†æ•°è®°å½•ä¸º çº¯æ–‡æœ¬ (TXT) æ–‡ä»¶ã€‚
         */
        function exportToTxt() {
            if (log1.length === 0 && log2.length === 0) {
                showCustomMessage("æ²¡æœ‰å¯å¯¼å‡ºçš„è®°å½•ã€‚", "bg-yellow-100 border-yellow-500 text-yellow-700");
                return;
            }

            // å¦‚æœæ­£åœ¨è®¡æ—¶ï¼Œæš‚åœè®¡æ—¶ä»¥è·å–å‡†ç¡®çš„ç»“æŸæ—¶é—´
            const wasRunning = (startTime !== null && !isPaused && !isGameOver);
            if(wasRunning) togglePause();
            
            const name1 = document.getElementById('player1Name').value;
            const name2 = document.getElementById('player2Name').value;
            
            // å®‰å…¨è·å–è®¾ç½®å€¼
            const targetScoreInput = document.getElementById('targetScoreInput');
            const toggleMatchPoint = document.getElementById('toggleMatchPoint');
            const toggleMatchPointMode = document.getElementById('toggleMatchPointMode'); // NEW: ä¸»å¼€å…³

            const matchPointModeChecked = toggleMatchPointMode?.checked ?? false;
            const targetScoreValue = targetScoreInput ? targetScoreInput.value : 'N/A';
            const matchPointChecked = toggleMatchPoint ? toggleMatchPoint.checked : true;
            
            // --- PLAIN TEXT EXPORT LOGIC ---
            const combinedLog = [
                ...log1.map(item => ({ ...item, player: 1, name: name1 })),
                ...log2.map(item => ({ ...item, player: 2, name: name2 }))
            ].sort((a, b) => a.timestamp - b.timestamp); 

            const nowTime = pausedAt || Date.now();
            
            // æ ¼å¼åŒ–æ—¥æœŸ
            const dateFormatOptions = { year: 'numeric', month: '2-digit', day: '2-digit' };
            const startDateStr = startTime ? new Date(startTime).toLocaleDateString('zh-CN', dateFormatOptions) : 'N/A (æ— è®°å½•)';
            const endDateStr = new Date(nowTime).toLocaleDateString('zh-CN', dateFormatOptions);

            let titleDateRange = endDateStr;
            if (startTime && startDateStr !== endDateStr) {
                titleDateRange = `${startDateStr} - ${endDateStr}`;
            } else if (startTime) {
                titleDateRange = startDateStr;
            }

            // è®¡ç®—å¹¶æ ¼å¼åŒ–æ€»æ—¶é•¿
            let durationString = 'N/A';
            if (startTime !== null) {
                const durationMs = (nowTime - startTime) - cumulativePausedDuration;
                durationString = formatDuration(durationMs);
            }
            
            // è·å–ç²¾ç¡®çš„å¼€å§‹å’Œç»“æŸæ—¶é—´
            const startDateTimeStr = startTime !== null ? formatDateTime(startTime) : 'N/A (æ— è®°å½•)';
            const endDateTimeStr = formatDateTime(nowTime);

            
            // å®šä¹‰åˆ—å®½
            const W_IDX = 5;
            const W_TIME = 8;
            const W_NAME = 12;
            const W_AMOUNT = 6;
            const W_SCORE = 10;
            const SEPARATOR = " | ";
            
            // çº¯æ–‡æœ¬æ–‡ä»¶å¤´
            let textContent = `æ¯”èµ›å¾—åˆ†è®°å½• - ${titleDateRange}\n`;
            textContent += `é˜Ÿä¼ A: ${name1}\né˜Ÿä¼ B: ${name2}\n`;
            textContent += `æœ€ç»ˆæ¯”åˆ†: ${score1} - ${score2}${isGameOver && matchPointModeChecked ? " (å·²ç»“æŸ)" : " (è¿›è¡Œä¸­)"}\n`;
            textContent += `èµ›ç‚¹æ¨¡å¼: ${matchPointModeChecked ? 'å¯ç”¨' : 'ç¦ç”¨ (æ— é™è®°åˆ†)'}\n`; 
            if (matchPointModeChecked) {
                 textContent += `èµ›ç‚¹ç›®æ ‡: ${targetScoreValue}\n`;
                 textContent += `ä¸¤åˆ†åˆ¶è·èƒœ: ${matchPointChecked ? 'å¯ç”¨' : 'ç¦ç”¨'}\n`;
            }
            textContent += `å¼€å§‹æ—¶é—´: ${startDateTimeStr}\n`;
            textContent += `ç»“æŸæ—¶é—´: ${endDateTimeStr}\n`;
            textContent += `è®¡æ—¶æ—¶é•¿: ${durationString}\n`;
            textContent += `ç´¯è®¡æš‚åœæ—¶é•¿: ${formatDuration(cumulativePausedDuration)}\n`;
            textContent += "====================================================================\n\n";

            // Header row
            let header = "";
            header += "åºå·".padEnd(W_IDX, ' ');
            header += SEPARATOR;
            header += "æ—¶é—´".padEnd(W_TIME, ' ');
            header += SEPARATOR;
            header += "é˜Ÿä¼".padEnd(W_NAME, ' ');
            header += SEPARATOR;
            header += "å˜åŒ–é‡".padEnd(W_AMOUNT, ' ');
            header += SEPARATOR;
            header += "æœ€ç»ˆæ¯”åˆ†"; 
            
            textContent += header + "\n";
            const LINE_SEP = "-".repeat(W_IDX + SEPARATOR.length + W_TIME + SEPARATOR.length + W_NAME + SEPARATOR.length + W_AMOUNT + SEPARATOR.length + W_SCORE);
            textContent += LINE_SEP + "\n";


            // Map log entries to Plain Text rows
            combinedLog.forEach((entry, index) => {
                const amountText = entry.amount > 0 ? `+${entry.amount}` : `${entry.amount}`;
                const scoreText = `${entry.scoreA} - ${entry.scoreB}`;
                
                let dataRow = "";
                dataRow += String(index + 1).padEnd(W_IDX, ' ');
                dataRow += SEPARATOR;
                dataRow += entry.time.padEnd(W_TIME, ' ');
                dataRow += SEPARATOR;
                dataRow += entry.name.padEnd(W_NAME, ' '); 
                dataRow += SEPARATOR;
                dataRow += amountText.padEnd(W_AMOUNT, ' ');
                dataRow += SEPARATOR;
                dataRow += scoreText;

                textContent += dataRow + "\n";
            });
            textContent += "\n====================================================================\n";

            // Create a Blob and trigger download
            const blob = new Blob([textContent], { type: 'text/plain;charset=utf-8;' });
            const link = document.createElement("a");
            const url = URL.createObjectURL(blob);
            
            link.setAttribute("href", url);
            
            const dateStr = new Date(nowTime).toISOString().slice(0, 10).replace(/-/g, '');
            link.setAttribute("download", `ScoreLog-${dateStr}.txt`);
            
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);

            showCustomMessage("è®°å½•å·²æˆåŠŸå¯¼å‡ºä¸º TXT æ–‡ä»¶ï¼", "bg-green-100 border-green-500 text-green-700");
            
            // å¦‚æœå¯¼å‡ºå‰è®¡æ—¶æ˜¯è¿è¡Œçš„ï¼Œåˆ™ç»§ç»­è®¡æ—¶
            if(wasRunning) togglePause(); // togglePause ä¼šé‡æ–°è°ƒç”¨ saveState
        }


        /**
         * é‡ç½®æ‰€æœ‰åˆ†æ•°ã€æ—¥å¿—å’Œåç§°ã€‚
         */
        function resetGame() {
            resetLocalState(); // åªé‡ç½®æœ¬åœ°çŠ¶æ€ï¼ŒresetLocalState å†…éƒ¨ä¼šè°ƒç”¨ saveState
        }
        
        /**
         * æ˜¾ç¤ºä¸€ä¸ªè‡ªå®šä¹‰çš„çŸ­æš‚æç¤ºä¿¡æ¯ï¼Œä»£æ›¿ alert()ã€‚
         */
        function showCustomMessage(message, tailwindClasses) {
            let messageBox = document.getElementById('customMessageBox');
            if (!messageBox) {
                messageBox = document.createElement('div');
                messageBox.id = 'customMessageBox';
                messageBox.className = 'fixed top-4 left-1/2 transform -translate-x-1/2 z-50 p-4 rounded-xl shadow-2xl transition-opacity duration-300 opacity-0';
                document.body.appendChild(messageBox);
            }

            messageBox.className = `fixed top-4 left-1/2 transform -translate-x-1/2 z-50 p-4 rounded-xl shadow-2xl transition-opacity duration-300 ${tailwindClasses}`;
            messageBox.textContent = message;
            
            // ç¡®ä¿ messageBox åœ¨é¡¶éƒ¨å¹¶å¯è§
            messageBox.classList.remove('opacity-0');
            messageBox.classList.add('opacity-100');

            setTimeout(() => {
                messageBox.classList.remove('opacity-100');
                messageBox.classList.add('opacity-0');
            }, 3000);
        }

        // é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–
        window.onload = function() {
            // å°è¯•åŠ è½½çŠ¶æ€ï¼Œå¦‚æœå¤±è´¥åˆ™æ‰§è¡Œé»˜è®¤é‡ç½®
            const stateLoaded = loadState(); 
            if (!stateLoaded) {
                resetLocalState();
            } else {
                // å¦‚æœæˆåŠŸåŠ è½½çŠ¶æ€ï¼Œä¹Ÿéœ€è¦ç¡®ä¿ UI çŠ¶æ€å’Œè®¡æ—¶å™¨æ˜¯æ­£ç¡®çš„
                updateSettingsVisibility(); 
                updateMainSettingsDisplay(); 
            }
        };

        // å°†å‡½æ•°æŒ‚è½½åˆ° window å¯¹è±¡ä¸Š
        window.changeScore = changeScore;
        window.resetGame = resetGame;
        window.togglePause = togglePause;
        window.exportToTxt = exportToTxt; 
        window.undoLastAction = undoLastAction;
        window.checkGameStatus = checkGameStatus; 
        window.openSettingsModal = openSettingsModal;
        window.closeSettingsModal = closeSettingsModal;
        window.updateSettingsVisibility = updateSettingsVisibility; 
        window.updateMainSettingsDisplay = updateMainSettingsDisplay;
        window.saveState = saveState; // æš´éœ² saveState ä¾› name input onchange ä½¿ç”¨
    </script>
</body>
</html>
